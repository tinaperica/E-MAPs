---
title: "spitzemap_construction"
author: "Chris Mathy"
date: "3/7/2019"
output: html_document
---

import packages
```{r echo=T, results='hide'}
library(tidyverse)
```

Read in the Gsp1 data, output from MATLAB
- The data is processed to have six labels for each strain (query or array) to match the labels
  used for the SGA preprocessing.
```{r}
name_to_ORF <- list()
name_to_ORF$array_allele_name <- read_delim('gsp1_pEMAP_avg_merged_gene_names.txt', delim='\t') %>% colnames()
name_to_ORF$array_ORF <- read_delim('gsp1_pEMAP_avg_merged.txt', delim='\t') %>% colnames()
name_to_ORF <- as.data.frame(name_to_ORF)

gsp1_pEMAP <-
  read_delim('gsp1_pEMAP_avg_merged_gene_names.txt', delim='\t') %>% 
  rename(query_allele_name = Gene) %>%
  separate(query_allele_name, into = c('query_name', 'query_mutant'),
           sep = ' - ', extra = "drop", remove = FALSE) %>% 
  mutate(query_ORF = 'YLR293C', query_descriptor = NA) %>% 
  unite('query_strain_id', c('query_ORF','query_mutant'), remove = FALSE) %>% 
  gather(-starts_with('query'), key = 'array_allele_name', value = 'score', na.rm = TRUE) %>%
  left_join(name_to_ORF, by = 'array_allele_name') %>% 
  separate(array_allele_name, into = c('array_name', 'array_descriptor'),
           sep = ' - ', extra = "drop", remove = FALSE) %>% 
  mutate('array_mutant' = NA,
         'array_strain_id' = paste(array_ORF, 'emap', sep = '_'),
         'interaction_network' = 'gsp1_pEMAP',
         'pvalue' = NA) %>%
  select(starts_with('query'), starts_with('array'), score, pvalue, interaction_network)
```

import SGA data and prepare it for concatenation
```{r}
load('../scaling_Costanzo_SGA_data/data/SGA_2016_full_scaled.rda')

SGA_to_combine <-
  SGA_scaled_to_EMAP %>% 
  mutate(interaction_network = paste(interaction_network, 'SGA', sep = '_')) %>% 
  select(interaction_network, starts_with('query'), starts_with('array'),
         -ends_with('smf'), -arraytype_temp, score_scaled_to_emap, pvalue) %>% 
  rename('score' = score_scaled_to_emap)
```

Combine pEMAP with SGA to make spitzemap, then save
```{r}
spitzemap <- bind_rows(gsp1_pEMAP, SGA_to_combine)
save(spitzemap, file = 'spitzemap.rda')
```

Load spitzemap (in case you are starting
```{r}
load('spitzemap.rda')
```

```{r}
old_names <- c('query_allele_name','query_name','query_strain_id',
              'query_mutant','query_ORF','query_descriptor',
              'array_allele_name','array_name','array_strain_id',
              'array_mutant','array_ORF','array_descriptor')
new_names <- c('array_allele_name','array_name','array_strain_id',
              'array_mutant','array_ORF','array_descriptor',
              'query_allele_name','query_name','query_strain_id',
              'query_mutant','query_ORF','query_descriptor')

spitzemapko <-
  spitzemap %>% 
  bind_rows(rename_at(spitzemap, vars(old_names), ~ new_names)) %>% 
  filter(interaction_network %in% c('gsp1_pEMAP','ExN_SGA','NxN_SGA'),
         array_name != 'GSP1',
         !grepl('_tsa', array_strain_id),
         !grepl('_tsq', array_strain_id))
spitzemapko <- spitzemap_for_corr
save(spitzemapko, file = 'spitzemapko.rda')

```

We must use unique id's whenever spreading, otherwise there
will be multiple values for the same row-column pair in the
wide format matrix. The following code shows that when using
the strain_id's as unique id's, the number of distinct rows
is equal to the number of rows of spitzemap_for_corr.
```{r}
spitzemapko %>% 
  select(query_strain_id, array_strain_id, score) %>%
  distinct() %>% 
  nrow()
  
# [1] 26556566

# nrow(spitzemap_for_corr)
# [1] 26556566

```

The following full spreading (long => wide) works for the full matrix, so the unique id's work
NOTE this takes super long to run
```{r}
cormat <-
  spitzemapko %>% 
  select(query_strain_id, array_strain_id, score) %>% 
  spread(query_strain_id, score) %>% 
  select(-array_strain_id) %>% 
  cor(., use = "pairwise.complete.obs", method = 'pearson')
```


The following code runs correlations for all of the partners with all of the gsp1 mutants
Note that the output plot has strain id's

TO DO:
the columns of the cormat can be changed to be the names by selecting the query_strain_id
and query_name from spitzemapko and using that dictionary to convert the names. 
```{r}
library(factoextra)
library(reshape2)

partners <- read_delim('partners.txt', delim = ',')

cormat <-
  spitzemapko %>% 
  filter(query_ORF %in% partners$ORF) %>%
  select(query_strain_id, array_ORF, score) %>% 
  spread(query_strain_id, score) %>% 
  select(-array_ORF) %>% 
  cor(., use = "pairwise.complete.obs", method = 'pearson')

dd <- as.dist((1-cormat)/2) # create a distance matrix, corr of "1" has dist 0 and "-1" has dist 1
hc <- hclust(dd) 
fviz_dend(hc, k = 7)
ggsave('dend.png', height = 10, width = 20)

cormat2 <- cormat[hc$order, hc$order]
melted_cormat2 <- melt(cormat2)
ggplot(data = melted_cormat2, aes(x=Var1, y=Var2, fill=value)) +
  geom_tile() + 
  scale_fill_gradient2(limits = c(-1, 1)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggsave('heatmap.png', height = 20, width = 20)

```




