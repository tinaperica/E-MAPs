---
title: "bin_then_corr.Rmd"
author: "Chris Mathy"
date: "3/8/2019"
output: html_document
---

import packages and data
```{r echo=T, results='hide'}
library(tidyverse)
load('../spitzemap/spitzemap.rda')
```

```{r}
spitzemap %>% distinct(interaction_network)

spitzemap_thin <-
  spitzemap %>% 
  filter(interaction_network != 'DAmP_SGA') %>% 
  select(ends_with('ORF'), ends_with('y_name'), ends_with('strain_id'), score, pvalue)
```

One question we might ask is: what is the distribution of pvalues for SGA scores that
  have been scaled to EMAP format? The plot below bins values in intervals of 1, so
  the boxplot for rounded_score of -1 corresponds to all scores between -1.00 and -1.99.
  We see that the median p-value is below 0.05 (-log(p) > 1.3) for scores > 3 or < -5.
```{r}
spitzemap %>% 
  filter(interaction_network != 'gsp1_pEMAP',
         abs(score) < 10) %>% 
  select(score, pvalue) %>% 
  mutate('neg_log_pvalue' = -log10(pvalue),
         'score_rounded' = as.factor(trunc(score))) %>% 
  ggplot(aes(x = score_rounded, y = neg_log_pvalue)) +
    geom_boxplot(outlier.shape = NA) +
    geom_hline(yintercept = -log10(0.05), color = 'red') +
    ylim(0,2) 

```

Goal here: bin first, using thresholds of 2, 3, and 5 (positive and negative),
because those are interesting confidence intervals as described in Collins et
al 2006 (figure 4b/c), and as measured by the p-val analysis for scaled SGA
scores above.

```{r}
spitzemap_sig2 <- filter(spitzemap_thin, abs(score) > 2)
spitzemap_sig3 <- filter(spitzemap_thin, abs(score) > 3)
spitzemap_sig5 <- filter(spitzemap_thin, abs(score) > 5)
```


Costanzo et al 2016 suggested three thresholds: lenient (P < 0.05),
intermediate (P < 0.05 and |score| > 0.08), and stringent confidence
(P <0.05 and score > 0.16 or score < -0.12). For the intermediate confidence,
the code below shows that the scaled score thresholds corresponding to
|score| > 0.08 are scaled_score < 2.25 and scaled_score < -2.97.

So we create 3 additional datasets, using thresholds of 2, 3, and 5 to reflect
the p-value filtering of 0.05 for all three thresholds -- the 3 and 5 datasets
pass the intermediate p-value confidence threshold for SGA data, and the 2
dataset will pass the lenient threshold

```{r}
spline_input <- read_delim('../scaling_Costanzo_SGA_data/scaler_output/spline.txt', delim = '\t')
scaling_spline <- smooth.spline(x = spline_input$score,
                                y = spline_input$scale,
                                spar = 0.02)
print(predict(scaling_spline, 0.08)$y * 0.08) # upper threshold
print(predict(scaling_spline, -0.08)$y * -0.08) # lower threshold

spitzemap_sig2_pfilter <- filter(spitzemap_sig2, (pvalue < 0.05 | is.na(pvalue)))
spitzemap_sig3_pfilter <- filter(spitzemap_sig3, (pvalue < 0.05 | is.na(pvalue)))
spitzemap_sig5_pfilter <- filter(spitzemap_sig5, (pvalue < 0.05 | is.na(pvalue)))
```



For each of these datasets, we want to perform the following computation:

  - select only the partners as queries
  - spread the partner subsets into wide format, i.e. rows are queries and
    columns are library/array genes.
  - remove columns with >10% NA
  - cluster in both directions
  - show heatmap


```{r}
partners <- read_delim('partners.txt', delim = ',')
```




```{r}

cluster <- function(data) {
  
  # compute the correlation matrix
  cormat <- round(cor(mydata),2)

  # melt the correlation matrix into long format
  melted_cormat <- gather(cormat, Var1, Var2)
  
  # visualize the correlation matrix
  ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
    geom_tile()
  
}


```


```{r}
# Cluster on correlations across all genes

corr_mat <- cor(gsp1_mat, use = "pairwise.complete.obs") # compute pairwise correlations on the columns (mutants)
dd <- as.dist((1-corr_mat)/2) # create a distance matrix, corr of "1" has dist 0 and "-1" has dist 2
hc <- hclust(dd)
corr_mat <- corr_mat[hc$order, hc$order]

melted_corr_mat <- melt(corr_mat)
min(melted_corr_mat$value)
(ggplot(data = melted_corr_mat, aes(x=Var1, y=Var2, fill=value))
 + geom_tile()
 + scale_fill_gradient2()
 + theme(axis.text.x = element_text(angle = 90, hjust = 1))
 + ggtitle("Pairwise hierarchical clustering of Gsp1 mutants \nusing full emap vector correlation as distance metric")
 + xlab("Gsp1 Mutant") + ylab("Gsp1 Mutant"))
ggsave('full_emap_mutant_clustering.png')
```


```{r}
# df <- data_spread[complete.cases(data_spread),]
# gene_names <- df[,1]$library_gene
# df <- df[,2:length(df)]
# cor_df <- cor(t(df))
# colnames(cor_df) <- gene_names
# rownames(cor_df) <- gene_names

reorder_cor_df <- function(cor_df){
    # Use correlation between variables as distance
    dd <- as.dist((1-cor_df)/2)
    hc <- hclust(dd)
    cor_df <- cor_df[hc$order, hc$order]
}

df <- data_spread[complete.cases(data_spread),] %>%
    select(R108Y, H141R, R112S, R112A, R108L,
           Y148I, R108Q, Q147E, H141I, T34A,
           R108I, G80A, Y157A, H141E, R78K,
           D79S, D79A, T34G, T34Q, T34E, K101R)
df <- df[,2:length(df)]
cor_df <- cor(df)


cor_df <- reorder_cor_df(cor_df)

melted_cor_df <- melt(cor_df)
ggplot(data = melted_cor_df, aes(x=Var1, y=Var2, fill=value)) +
    geom_tile() +
    scale_fill_gradient2(low = "green", mid = "white", high = "blue") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          axis.text = element_text(size = 20),
          axis.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          legend.title = element_text(size = 20)) +
    xlab('Gsp1 Point Mutant') +
    ylab('Gsp1 Point Mutant') +
    guides(fill = guide_legend(title="Correlation\nof E-MAP\nprofiles"))
ggsave("~/Desktop/emap_strong_mutant_correlations.png", width = 12, height = 10, dpi = 300)

```

```{r}
reorder_cor_df <- function(cor_df){
    # Use correlation between variables as distance
    dd <- as.dist((1-cor_df)/2)
    hc <- hclust(dd)
    cor_df <- cor_df[hc$order, hc$order]
}


cor_df <- cor(select(ranked_NMR_data, -query))
cor_df <- reorder_cor_df(cor_df)

cor_df

melted_cor_df <- melt(cor_df)
ggplot(data = melted_cor_df, aes(x=Var1, y=Var2, fill=value)) +
    geom_tile() +
    scale_fill_gradient2(low = "green", mid = "white", high = "blue") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          axis.text = element_text(size = 20),
          axis.title = element_text(size = 20),
          legend.text = element_text(size = 20),
          legend.title = element_text(size = 20)) +
    xlab('Gsp1 Point Mutant') +
    ylab('Gsp1 Point Mutant') +
    guides(fill = guide_legend(title="Correlation\nof E-MAP\nprofiles"))
# ggsave("~/Desktop/emap_strong_mutant_correlations.png", width = 12, height = 10, dpi = 300)
```
