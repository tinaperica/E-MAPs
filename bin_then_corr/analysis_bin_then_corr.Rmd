---
title: "gi_confidence_thresholds.Rmd"
author: "Chris Mathy"
date: "3/8/2019"
output: html_document
---

import packages and data
```{r echo=T, results='hide'}
library(tidyverse)
library(reshape2)
library(mclust)
library(factoextra)

load('../spitzemap/spitzemap.rda')
partners <- read_delim('partners.txt', delim = ',')
```

One question we might ask is: what is the distribution of pvalues for SGA scores that
  have been scaled to EMAP format? The plot below bins values in intervals of 1, so
  the boxplot for rounded_score of -1 corresponds to all scores between -1.00 and -1.99.
  We see that the median p-value is below 0.05 (-log(p) > 1.3) for scores > 3 or < -5.
```{r}
spitzemap %>% 
  filter(interaction_network != 'gsp1_pEMAP',
         abs(score) < 10) %>%
  select(score, pvalue) %>%
  mutate('neg_log_pvalue' = -log10(pvalue),
         'score_rounded' = as.factor(trunc(score))) %>%
  ggplot(aes(x = score_rounded, y = neg_log_pvalue)) +
    geom_boxplot(outlier.shape = NA) +
    geom_hline(yintercept = -log10(0.05), color = 'red') +
    ylim(0,2) +
    ggtitle('Distribution of SGA p-values scaled to EMAP format (scores truncated)
             red line indicates a p-value of 0.05')

ggsave('SGA_scaled_score_vs_pval.png')

```

get weighting function for EMAP scores based on Collins et al 2006 (fig 4c)
```{r}

d <- data.frame(avg_S_score = seq(-6, 6, by=0.5),
                confidence = c(1, 1, 0.99, 0.98, 0.95, 0.9, 0.85, 0.65, 0.45,
                               0.2, 0.15, 0.08, 0, 0.05, 0.07, 0.15,
                               0.22, 0.5, 0.65, 0.75, 0.87, 0.93, .95, .98, 0.95))

confidence_spline <- smooth.spline(x = d$avg_S_score,
                                   y = d$confidence,
                                   spar = 0.3)

confidence_fxn <- data.frame(x <- seq(-6, 6, by = 0.1),
                             y <- predict(confidence_spline, seq(-6, 6, by = 0.1))$y)

ggplot(confidence_fxn, aes(x=x, y=y)) +
  geom_point(color='red') +
  geom_hline(yintercept = 0.95, color = 'blue') +
  theme(
    panel.background = element_rect(fill = "transparent",colour = NA), # or theme_blank()
    plot.background = element_rect(fill = "transparent",colour = NA),
    text = element_text(size=26))
ggsave('spline.png')
ggsave('spline_transparent.png', bg = 'transparent')

```


```{r}
spitzemap_thin <-
  spitzemap %>% 
  filter(interaction_network %in% c('NxN_SGA', 'ExN_SGA')) %>% 
  select(ends_with('ORF'), ends_with('y_name'), ends_with('strain_id'), score, pvalue) %>% 
  select(starts_with('Query'), starts_with('Array'), score, pvalue)
```


Goal here: bin first, using thresholds of 2, 3, and 5 (positive and negative),
because those are interesting confidence intervals as described in Collins et
al 2006 (figure 4b/c), and as measured by the p-val analysis for scaled SGA
scores above.

Additionall, Costanzo et al 2016 suggested three thresholds: lenient (P < 0.05),
intermediate (P < 0.05 and |score| > 0.08), and stringent confidence
(P <0.05 and score > 0.16 or score < -0.12). For the intermediate confidence,
the code below shows that the scaled score thresholds corresponding to
|score| > 0.08 are scaled_score < 2.25 and scaled_score < -2.97.

So we create 3 additional datasets, using thresholds of 2, 3, and 5 to reflect
the p-value filtering of 0.05 for all three thresholds -- the 3 and 5 datasets
pass the intermediate p-value confidence threshold for SGA data, and the 2
dataset will pass the lenient threshold

```{r}


# score filtering based on a threhold
score_threshold = 3
spitzemap_sig <- filter(spitzemap_thin, abs(score) > score_threshold)

# SGA p-value filtering
spline_input <- read_delim('../scaling_Costanzo_SGA_data/scaler_output/spline.txt', delim = '\t')
scaling_spline <- smooth.spline(x = spline_input$score,
                                y = spline_input$scale,
                                spar = 0.02)

# need to add adjustment to score first (adjustment = .0051)
adj = .0051
print(predict(scaling_spline, 0.08 + adj)$y * (0.08 + adj)) # upper threshold
print(predict(scaling_spline, -0.08 + adj)$y * (-0.08 + adj)) # lower threshold

spitzemap_sig <- filter(spitzemap_thin, abs(score) > score_threshold)


spitzemap_sig_pfilter <-
  spitzemap_sig %>% 
  filter(pvalue < 0.05 | is.na(pvalue) | ))

```



